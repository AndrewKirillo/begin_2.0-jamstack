# Sources data by pinging our Netlify Functions on a cron schedule

name: Data Sourcing

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:
  

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  source:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Get JWT Expiration
        id: get-exp
        run: echo "::set-output name=exp::$((($(date +%s%N)/1000000) + (1000 * 60 * 60)))"

      - name: Generate JWT
        id: gen-jwt
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        uses: morzzz007/github-actions-jwt-generator@1.0.1
        with:
          # The shared secret used to sign the JWTs
          secret: ${{ env.JWT_SECRET }}
          # The payload to encrypt
          payload: '{ "exp": ${{steps.get-exp.outputs.exp}} }'

      - name: Source RSS
        id: source-rss
        uses: Satak/webrequest-action@v1.2.3
        with:
          url: http://9a5ae3090ea7.ngrok.io/.netlify/functions/test
          headers: '{ "Authorization": "Bearer ${{ steps.gen-jwt.outputs.token }}" }'
